!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.PSDLIB=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var File=function(){this.pointer=0,this.arrayBuffer=void 0,this.dataView=void 0};module.exports=File,File.prototype.create=function(length){this.arrayBuffer=new ArrayBuffer(length),this.dataView=new DataView(this.arrayBuffer)},File.prototype.open=function(arrayBuffer){this.arrayBuffer=arrayBuffer,this.dataView=new DataView(this.arrayBuffer)},File.prototype.skip=function(length){this.pointer+=length},File.prototype.revert=function(length){this.pointer-=length},File.prototype.extend=function(length){for(var newArrayBuffer=new ArrayBuffer(this.arrayBuffer.byteLength+length),newDataView=new DataView(newArrayBuffer),i=0;i<this.arrayBuffer.byteLength;i++)newDataView.setUint8(i,this.dataView.getUint8(i));this.arrayBuffer=newArrayBuffer,this.dataView=newDataView},File.prototype.read8Bits=function(length){var base10=this.readUint8(),base2=base10.toString(2),bits=("00000000"+base2).slice(-8).split("").map(function(x){return parseInt(x,10)});return bits},File.prototype.write8Bits=function(bits){var byte=parseInt(bits.join(""),2);this.writeUint8(byte)},File.prototype.readInt8Array=function(length){var data=new Int8Array(this.arrayBuffer,this.pointer,length);return this.pointer+=length,data},File.prototype.readUint8Array=function(length){var data=new Uint8Array(this.arrayBuffer,this.pointer,length);return this.pointer+=length,data},File.prototype.writeUint8Array=function(data){for(var i=0;i<data.length;i++)this.writeUint8(data[i])},File.prototype.readInt16Array=function(length){var data=new Int16Array(this.arrayBuffer,this.pointer,length);return this.pointer+=2*length,data},File.prototype.readUint16Array=function(length){var data=new Uint16Array(this.arrayBuffer,this.pointer,length);return this.pointer+=2*length,data},File.prototype.readInt8=function(){var data=this.dataView.getInt8(this.pointer);return this.pointer+=1,data},File.prototype.readUint8=function(){var data=this.dataView.getUint8(this.pointer);return this.pointer+=1,data},File.prototype.writeUint8=function(data){this.dataView.setUint8(this.pointer,data),this.pointer+=1},File.prototype.readInt16=function(){var data=this.dataView.getInt16(this.pointer);return this.pointer+=2,data},File.prototype.readUint16=function(){var data=this.dataView.getUint16(this.pointer);return this.pointer+=2,data},File.prototype.writeUint16=function(data){this.dataView.setUint16(this.pointer,data),this.pointer+=2},File.prototype.readInt32=function(){var data=this.dataView.getInt32(this.pointer);return this.pointer+=4,data},File.prototype.readUint32=function(){var data=this.dataView.getUint32(this.pointer);return this.pointer+=4,data},File.prototype.writeUint32=function(data){this.dataView.setUint32(this.pointer,data),this.pointer+=4},File.prototype.readFloat32=function(){var data=this.dataView.getFloat32(this.pointer);return this.pointer+=4,data},File.prototype.writeFloat32=function(data){this.dataView.setFloat32(this.pointer,data),this.pointer+=4},File.prototype.readFloat64=function(){var data=this.dataView.getFloat64(this.pointer);return this.pointer+=8,data},File.prototype.writeFloat64=function(data){this.dataView.setFloat64(this.pointer,data),this.pointer+=8},File.prototype.readString=function(length){for(var string="",charCodes=this.readUint8Array(length),i=0;length>i;i++)string+=String.fromCharCode(charCodes[i]);return string},File.prototype.writeString=function(string){for(var i=0;i<string.length;i++)this.writeUint8(string.charCodeAt(i))},File.prototype.readPascalString=function(extra){var length=this.readUint8(),string=this.readString(length);return"evenLength"==extra&&(length+1)%2!==0?this.skip(1):"multipleOfFourBytes"==extra&&(length+1)%4!==0&&this.skip(4-(length+1)%4),string},File.prototype.writePascalString=function(string,extra){if(this.writeUint8(string.length),this.writeString(string),"evenLength"==extra&&(string.length+1)%2!==0)this.writeUint8(0);else if("multipleOfFourBytes"==extra&&(string.length+1)%4!==0)for(var zerosToWrite=4-(string.length+1)%4,i=0;zerosToWrite>i;i++)this.writeUint8(0);return string},File.prototype.readUnicodeString=function(){for(var string="",length=this.readUint32(),i=0;length>i;i++){var charCode=this.readUint16();0!==charCode&&(string+=String.fromCharCode(charCode))}return string},File.prototype.writeUnicodeString=function(string){this.writeUint32(string.length);for(var i=0;i<string.length;i++)this.writeUint16(string.charCodeAt(i));return string}},{}],2:[function(require,module,exports){var types=require("./additionalLayerInfoTypes.js"),FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){var item={};fileHelper.skip(4),item.key=fileHelper.readString(4),item.name=types[item.key].name;var dataLength=fileHelper.readUint32(),startPosition=fileHelper.pointer;return void 0!==types[item.key].module?item.data=types[item.key].module.parse(fileHelper,dataLength):item.data=fileHelper.readUint8Array(dataLength),fileHelper.pointer<startPosition+dataLength&&fileHelper.skip(dataLength-(fileHelper.pointer-startPosition)),item},exports.compose=function(record){var sectionData=new FileHelper;if(sectionData.create(0),void 0!==record.additionalLayerInfo)for(var i=0;i<record.additionalLayerInfo.length;i++){var info=record.additionalLayerInfo[i];if(void 0!==types[info.key]&&void 0!==types[info.key].module)var infoSection=new Uint8Array(types[info.key].module.compose(info.data));else var infoSection=info.data;sectionData.extend(infoSection.length+12),sectionData.writeString("8BIM"),sectionData.writeString(info.key),sectionData.writeUint32(infoSection.length),sectionData.writeUint8Array(infoSection)}return sectionData.arrayBuffer}},{"./FileHelper.js":1,"./additionalLayerInfoTypes.js":3}],3:[function(require,module,exports){module.exports={lrFX:{name:"Effects Layer"},tySh:{name:"Type Tool"},luni:{name:"Unicode layer name",module:require("./additionalLayerInfoTypes/luni.js")},lyid:{name:"Layer ID",module:require("./additionalLayerInfoTypes/lyid.js")},lfx2:{name:"Object-based effects layer"},Patt:{name:"Pattern"},Pat2:{name:"Pattern 2"},Pat3:{name:"Pattern 3"},Anno:{name:"Annotations"},clbl:{name:"Blend clipping elements",module:require("./additionalLayerInfoTypes/clbl.js")},infx:{name:"Blend interior elements",module:require("./additionalLayerInfoTypes/infx.js")},knko:{name:"Knockout setting",module:require("./additionalLayerInfoTypes/knko.js")},lspf:{name:"Protected setting",module:require("./additionalLayerInfoTypes/lspf.js")},lclr:{name:"Sheet color setting",module:require("./additionalLayerInfoTypes/lclr.js")},fxrp:{name:"Reference point",module:require("./additionalLayerInfoTypes/fxrp.js")},grdm:{name:"Gradient settings"},lsct:{name:"Section divider setting",module:require("./additionalLayerInfoTypes/lsct.js")},brst:{name:"Channel blending restrictions setting"},SoCo:{name:"Solid color sheet setting"},PtFl:{name:"Pattern fill setting"},GdFl:{name:"Gradient fill setting"},vmsk:{name:"Vector mask setting"},vsms:{name:"Vector mask setting"},TySh:{name:"Type tool object setting"},ffxi:{name:"Foreign effect ID",module:require("./additionalLayerInfoTypes/ffxi.js")},lnsr:{name:"Layer name source setting",module:require("./additionalLayerInfoTypes/lnsr.js")},shpa:{name:"Pattern data"},shmd:{name:"Metadata setting"},lyvr:{name:"Layer version",module:require("./additionalLayerInfoTypes/lyvr.js")},tsly:{name:"Transparency shapes layer",module:require("./additionalLayerInfoTypes/tsly.js")},lmgm:{name:"Layer mask as global mask",module:require("./additionalLayerInfoTypes/lmgm.js")},vmgm:{name:"Vector mask as global mask",module:require("./additionalLayerInfoTypes/vmgm.js")},brit:{name:"Brightness/Contrast",module:require("./additionalLayerInfoTypes/brit.js")},mixr:{name:"Channel Mixer"},clrL:{name:"Color Lookup"},plLd:{name:"Placed Layer"},lnkD:{name:"Linked Layer"},lnk2:{name:"Linked Layer"},lnk3:{name:"Linked Layer"},phfl:{name:"Photo Filter"},blwh:{name:"Black White"},CgEd:{name:"Content Generator Extra Data"},Txt2:{name:"Text Engine Data",module:require("./additionalLayerInfoTypes/txt2.js")},vibA:{name:"Vibrance"},pths:{name:"Unicode Path Name"},anFX:{name:"Animation Effects"},FMsk:{name:"Filter Mask"},SoLd:{name:"Placed Layer Data"},vstk:{name:"Vector Stroke Data"},vscg:{name:"FVector Stroke Content Data"},sn2P:{name:"Using Aligned Rendering",module:require("./additionalLayerInfoTypes/sn2p.js")},vogk:{name:"Vector Origination Data"},Mtrn:{name:"Saving Merged Transparency"},Mt16:{name:"Saving Merged Transparency"},Mt32:{name:"Saving Merged Transparency"},LMsk:{name:"User Mask"},expA:{name:"Exposure",module:require("./additionalLayerInfoTypes/expa.js")},FXid:{name:"Filter Mask"},FEid:{name:"Filter Effects"},SoCo:{name:"Solid Color"},PtFl:{name:'Pattern"'},levl:{name:"Levels",module:require("./additionalLayerInfoTypes/levl.js")},curv:{name:"Curves"},"hue ":{name:"Old Hue/saturation"},hue2:{name:"Hue/saturation"},blnc:{name:"Color Balance"},nvrt:{name:"Invert"},post:{name:"Posterize"},thrs:{name:"Threshold"},selc:{name:"Selective color"}}},{"./additionalLayerInfoTypes/brit.js":4,"./additionalLayerInfoTypes/clbl.js":5,"./additionalLayerInfoTypes/expa.js":6,"./additionalLayerInfoTypes/ffxi.js":7,"./additionalLayerInfoTypes/fxrp.js":8,"./additionalLayerInfoTypes/infx.js":9,"./additionalLayerInfoTypes/knko.js":10,"./additionalLayerInfoTypes/lclr.js":11,"./additionalLayerInfoTypes/levl.js":12,"./additionalLayerInfoTypes/lmgm.js":13,"./additionalLayerInfoTypes/lnsr.js":14,"./additionalLayerInfoTypes/lsct.js":15,"./additionalLayerInfoTypes/lspf.js":16,"./additionalLayerInfoTypes/luni.js":17,"./additionalLayerInfoTypes/lyid.js":18,"./additionalLayerInfoTypes/lyvr.js":19,"./additionalLayerInfoTypes/sn2p.js":20,"./additionalLayerInfoTypes/tsly.js":21,"./additionalLayerInfoTypes/txt2.js":22,"./additionalLayerInfoTypes/vmgm.js":23}],4:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data={};return data.brightness=fileHelper.readUint16(),data.contrast=fileHelper.readUint16(),data.mean=fileHelper.readUint16(),data.labOnly=Boolean(fileHelper.readUint8()),data},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(7),sectionData.writeUint16(data.brightness),sectionData.writeUint16(data.contrast),sectionData.writeUint16(data.mean),sectionData.writeUint8(data.labOnly?1:0),sectionData.arrayBuffer}},{"../FileHelper.js":1}],5:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data=Boolean(fileHelper.readUint8());return fileHelper.skip(3),data},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(4),sectionData.writeUint8(data?1:0),sectionData.arrayBuffer}},{"../FileHelper.js":1}],6:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data={};return data.version=fileHelper.readUint16(),data.exposure=fileHelper.readUint32(),data.offset=fileHelper.readUint32(),data.gamma=fileHelper.readUint32(),data},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(14),sectionData.writeUint16(data.version),sectionData.writeUint32(data.exposure),sectionData.writeUint32(data.offset),sectionData.writeUint32(data.gamma),sectionData.arrayBuffer}},{"../FileHelper.js":1}],7:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){return fileHelper.readUint32()},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(4),sectionData.writeUint32(data),sectionData.arrayBuffer}},{"../FileHelper.js":1}],8:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data={};return data.x=fileHelper.readFloat64(),data.y=fileHelper.readFloat64(),data},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(16),sectionData.writeFloat64(data.x),sectionData.writeFloat64(data.y),sectionData.arrayBuffer}},{"../FileHelper.js":1}],9:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:5}],10:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:5}],11:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data=fileHelper.readUint32();return fileHelper.skip(4),data},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(8),sectionData.writeUint32(data),sectionData.writeUint32(0),sectionData.arrayBuffer}},{"../FileHelper.js":1}],12:[function(require,module,exports){function parseLevelRecord(fileHelper){var record={};return record.inputFloor=fileHelper.readUint16(),record.inputCeiling=fileHelper.readUint16(),record.outputFloor=fileHelper.readUint16(),record.outputCeiling=fileHelper.readUint16(),record.gamma=fileHelper.readUint16(),record}var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var data={};data.version=fileHelper.readUint16(),data.records=[];for(var i=0;29>i;i++)data.records.push(parseLevelRecord(fileHelper));var extraLevelsMarker=fileHelper.readString(4);if("Lvls"===extraLevelsMarker){data.version=fileHelper.readUint16();for(var extraLevelsCount=fileHelper.readUint16()-29,i=0;extraLevelsCount>i;i++)data.records.push(parseLevelRecord(fileHelper))}else fileHelper.revert(4);return data},exports.compose=function(data){var sectionData=new FileHelper;sectionData.create(292),sectionData.writeUint16(2);for(var i=0;29>i;i++)sectionData.writeUint16(data.records[i].inputFloor),sectionData.writeUint16(data.records[i].inputCeiling),sectionData.writeUint16(data.records[i].outputFloor),sectionData.writeUint16(data.records[i].outputCeiling),sectionData.writeUint16(data.records[i].gamma);if(3===data.version){var additionalRecordCount=data.records.length-29;sectionData.extend(8+10*additionalRecordCount),sectionData.writeString("Lvls"),sectionData.writeUint16(3),sectionData.writeUint16(data.records.length);for(var i=29;i<data.records.length;i++)sectionData.writeUint16(data.records[i].inputFloor),sectionData.writeUint16(data.records[i].inputCeiling),sectionData.writeUint16(data.records[i].outputFloor),sectionData.writeUint16(data.records[i].outputCeiling),sectionData.writeUint16(data.records[i].gamma)}return sectionData.arrayBuffer}},{"../FileHelper.js":1}],13:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:5}],14:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){return fileHelper.readUint32()},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(4),sectionData.writeUint32(data),sectionData.arrayBuffer}},{"../FileHelper.js":1}],15:[function(require,module,exports){var blendModes=require("../blendModes.js"),FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper,dataLength){var data={},type=fileHelper.readUint32();return 0===type?data.type="other":1===type?data.type="open folder":2===type?data.type="closed folder":3===type&&(data.type="divider"),dataLength>=12&&(fileHelper.skip(4),data.blendMode=blendModes[fileHelper.readString(4)]),dataLength>=16&&(0===fileHelper.readUint32()?data.subType="normal":data.subType="scene group"),data},exports.compose=function(data){var sectionData=new FileHelper;if(sectionData.create(4),"other"===data.type?sectionData.writeUint32(0):"open folder"===data.type?sectionData.writeUint32(1):"closed folder"===data.type?sectionData.writeUint32(2):"divider"===data.type&&sectionData.writeUint32(3),void 0!==data.blendMode){var blendModeKey=Object.keys(blendModes).filter(function(key){return blendModes[key]===data.blendMode})[0];sectionData.extend(8),sectionData.writeString("8BIM"),sectionData.writeString(blendModeKey)}return void 0!==data.subType&&(sectionData.extend(4),"scene group"===data.subType?sectionData.writeUint32(1):sectionData.writeUint32(0)),sectionData.arrayBuffer}},{"../FileHelper.js":1,"../blendModes.js":24}],16:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var flags=fileHelper.read8Bits(),data={transparancy:!1,composite:!1,position:!1};return fileHelper.skip(3),1===flags[0]&&(data.transparency=!0),1===flags[1]&&(data.composite=!0),1===flags[2]&&(data.position=!0),data},exports.compose=function(data){var sectionData=new FileHelper,flags=[0,0,0,0,0,0,0,0];return sectionData.create(4),sectionData.writeUint8(0),sectionData.writeUint8(0),sectionData.writeUint8(0),data.transparency&&(flags[0]=1),data.composite&&(flags[1]=1),data.position&&(flags[2]=1),sectionData.write8Bits(flags),sectionData.arrayBuffer}},{"../FileHelper.js":1}],17:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){return fileHelper.readUnicodeString()},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(2*data.length+6),sectionData.writeUnicodeString(data),sectionData.arrayBuffer}},{"../FileHelper.js":1}],18:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){return fileHelper.readUint32()},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(4),sectionData.writeUint32(data),sectionData.arrayBuffer}},{"../FileHelper.js":1}],19:[function(require,module,exports){arguments[4][18][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:18}],20:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){return Boolean(fileHelper.readUint32())},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(4),sectionData.writeUint32(data?1:0),sectionData.arrayBuffer}},{"../FileHelper.js":1}],21:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:5}],22:[function(require,module,exports){var FileHelper=require("../FileHelper.js");exports.parse=function(fileHelper){var length=fileHelper.readUint32();return fileHelper.readUint8Array(length)},exports.compose=function(data){var sectionData=new FileHelper;return sectionData.create(data.length+4),sectionData.writeUint32(data.length),sectionData.writeUint8Array(data),sectionData.arrayBuffer}},{"../FileHelper.js":1}],23:[function(require,module,exports){arguments[4][5][0].apply(exports,arguments)},{"../FileHelper.js":1,dup:5}],24:[function(require,module,exports){module.exports={pass:"pass through",norm:"normal",diss:"dissolve",dark:"darken","mul ":"multiply",idiv:"color burn",lbrn:"linear burn",dkCl:"darker color",lite:"lighten",scrn:"screen","div ":"color dodge",lddg:"linear dodge",lgCl:"lighter color",over:"overlay",sLit:"soft light",hLit:"hard light",vLit:"vivid light",lLit:"linear light",pLit:"pin light",hMix:"hard mix",diff:"difference",smud:"exclusion",fsub:"subtract",fdiv:"divide","hue ":"hue","sat ":"saturation",colr:"color","lum ":"luminosity"}},{}],25:[function(require,module,exports){var FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){for(var blendingRanges=[],sectionLength=fileHelper.readUint32(),i=0;sectionLength>i;i+=4)blendingRanges.push([fileHelper.readUint8(),fileHelper.readUint8(),fileHelper.readUint8(),fileHelper.readUint8()]);return blendingRanges},exports.compose=function(record){var sectionData=new FileHelper;if(void 0!==record.blendingRanges){var sectionDataLength=4*record.blendingRanges.length;sectionData.create(sectionDataLength+4),sectionData.writeUint32(sectionDataLength);for(var i=0;i<record.blendingRanges.length;i++)sectionData.writeUint8Array(record.blendingRanges[i])}else{var ranges=2*record.channels.length+2;sectionData.create(4*ranges+4),sectionData.writeUint32(4*ranges);for(var i=0;ranges>i;i++)sectionData.writeUint8Array([0,0,255,255])}return sectionData.arrayBuffer}},{"./FileHelper.js":1}],26:[function(require,module,exports){var imageData=require("./imageData.js"),FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper,layers){for(var i=0;i<layers.length;i++){var record=layers[i];record.channels=[];for(var j=0;j<record.channelInfo.length;j++){var id=record.channelInfo[j].id,width=-1>id?record.maskData.width:record.width,height=-1>id?record.maskData.height:record.height;record.channels.push({id:id,data:imageData.parse(fileHelper,width,height,1)[0]})}delete record.channelInfo}},exports.compose=function(fileHelper,psd){var psd=psd||{},sectionData=new FileHelper;if(sectionData.create(0),void 0!==psd.layers&&void 0!==psd.layers[0])for(var i=0;i<psd.layers.length;i++)for(var record=psd.layers[i],j=0;j<record.channels.length;j++)sectionData.extend(record.channels[j].data.byteLength+2),sectionData.writeUint16(0),sectionData.writeUint8Array(record.channels[j].data);return sectionData.arrayBuffer}},{"./FileHelper.js":1,"./imageData.js":30}],27:[function(require,module,exports){exports.parse=function(fileHelper){var sectionLength=fileHelper.readUint32(),colorModeData=[];return sectionLength>0&&(console.error("Neither Indexed nor Duotone colormode supported yet!"),colorModeData=fileHelper.readUint8Array(sectionLength)),colorModeData},exports.compose=function(fileHelper,psd){var psd=psd||{};void 0!==psd.colorModeData&&console.error("Neither Indexed nor Duotone colormode supported yet!"),fileHelper.extend(4),fileHelper.writeUint32(0)}},{}],28:[function(require,module,exports){var FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){var globalLayerMaskInfo={},sectionLength=fileHelper.readUint32(),startPosition=fileHelper.pointer;return 0!==sectionLength&&(globalLayerMaskInfo.overlayColorSpace=fileHelper.readUint16(),globalLayerMaskInfo.colorComponents=[],globalLayerMaskInfo.colorComponents.push(fileHelper.readInt16()),globalLayerMaskInfo.colorComponents.push(fileHelper.readInt16()),globalLayerMaskInfo.colorComponents.push(fileHelper.readInt16()),globalLayerMaskInfo.colorComponents.push(fileHelper.readInt16()),globalLayerMaskInfo.opacity=fileHelper.readUint16(),globalLayerMaskInfo.kind=fileHelper.readUint8(),fileHelper.skip(sectionLength-(fileHelper.pointer-startPosition))),globalLayerMaskInfo},exports.compose=function(fileHelper,psd){var psd=psd||{},sectionData=new FileHelper;return sectionData.create(4),void 0!==psd.globalLayerMaskInfo&&void 0!==psd.globalLayerMaskInfo.overlayColorSpace&&(sectionData.writeUint32(16),sectionData.extend(16),sectionData.writeUint16(psd.globalLayerMaskInfo.overlayColorSpace),sectionData.writeUint16(psd.globalLayerMaskInfo.colorComponents[0]),sectionData.writeUint16(psd.globalLayerMaskInfo.colorComponents[1]),sectionData.writeUint16(psd.globalLayerMaskInfo.colorComponents[2]),sectionData.writeUint16(psd.globalLayerMaskInfo.colorComponents[3]),sectionData.writeUint16(psd.globalLayerMaskInfo.opacity),sectionData.writeUint8(psd.globalLayerMaskInfo.kind)),sectionData.arrayBuffer}},{"./FileHelper.js":1}],29:[function(require,module,exports){var colormodes=["Bitmap","Grayscale","Indexed","RGB","CMYK","HSL","HSB","Multichannel","Duotone","Lab"];exports.parse=function(fileHelper){var fileHeader={},signature=fileHelper.readString(4),version=fileHelper.readUint16();return fileHeader.valid=!1,"8BPS"===signature&&1===version&&(fileHelper.skip(6),fileHeader.valid=!0,fileHeader.channels=fileHelper.readUint16(),fileHeader.height=fileHelper.readUint32(),fileHeader.width=fileHelper.readUint32(),fileHeader.depth=fileHelper.readUint16(),fileHeader.colormode=colormodes[fileHelper.readUint16()]),fileHeader},exports.compose=function(fileHelper,psd){var psd=psd||{};fileHelper.extend(26),fileHelper.writeString("8BPS"),fileHelper.writeUint16(1),fileHelper.writeUint8Array([0,0,0,0,0,0]),fileHelper.writeUint16(psd.channels),fileHelper.writeUint32(psd.height),fileHelper.writeUint32(psd.width),fileHelper.writeUint16(psd.depth||8),fileHelper.writeUint16(colormodes.indexOf(psd.colormode||"RGB"))}},{}],30:[function(require,module,exports){var rle=require("./rle.js");exports.parse=function(fileHelper,width,height,channelCount){var imageData=[],pixelCount=width*height;try{var compression=fileHelper.readUint16();if(0===compression)for(var i=0;channelCount>i;i++)imageData[i]=fileHelper.readUint8Array(pixelCount);else if(1===compression){for(var scanLineCount=height*channelCount,byteCounts=[],decompressedData=new Uint8Array(scanLineCount*width),i=0;scanLineCount>i;i++)byteCounts[i]=fileHelper.readUint16();for(var i=0;scanLineCount>i;i++){var encodedArray=fileHelper.readInt8Array(byteCounts[i]),decodedArray=rle.decode(encodedArray);decompressedData.set(decodedArray,i*width)}for(var i=0;channelCount>i;i++)imageData[i]=decompressedData.slice(i*pixelCount,i*pixelCount+pixelCount)}else console.error("FATAL ERROR: Unknown compression type "+compression)}catch(exception){}return imageData},exports.compose=function(fileHelper,psd){var psd=psd||{};if(void 0!==psd.imageData&&void 0!==psd.imageData[0]){fileHelper.extend(psd.imageData[0].length*psd.imageData.length+2),fileHelper.writeUint16(0);for(var i=0;i<psd.imageData.length;i++)fileHelper.writeUint8Array(psd.imageData[i])}else fileHelper.extend(3)}},{"./rle.js":38}],31:[function(require,module,exports){exports.toBase64=function(){if("undefined"==typeof window)return void console.error("This function is not yet supported outside of browsers.");var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");if(canvas.width=this.width,canvas.height=this.height,this.width>0&&this.height>0){var imageData=ctx.getImageData(0,0,this.width,this.height),r=this.channels.filter(function(channel){return 0===channel.id})[0],g=this.channels.filter(function(channel){return 1===channel.id})[0],b=this.channels.filter(function(channel){return 2===channel.id})[0],a=this.channels.filter(function(channel){return-2===channel.id})[0];void 0===a&&(a=this.channels.filter(function(channel){return-1===channel.id})[0]);for(var y=0;y<this.height;y++)for(var x=0;x<this.width;x++){var index=this.width*y+x,maskIndex=index;if(void 0!==this.maskData&&void 0!==this.maskData.top)var yMask=y+this.top-this.maskData.top,xMask=x+this.left-this.maskData.left,maskIndex=this.maskData.width*yMask+xMask;imageData.data[4*index]=r.data[index],imageData.data[4*index+1]=g.data[index],imageData.data[4*index+2]=b.data[index],void 0!==a&&void 0!==a.data?imageData.data[4*index+3]=a.data[maskIndex]:imageData.data[4*index+3]=255}ctx.putImageData(imageData,0,0)}return canvas.toDataURL("image/png")},exports.toPng=function(){if("undefined"==typeof window)return void console.error("This function is not yet supported outside of browsers.");var dataUrl=this.toBase64(),image=new Image;return image.width=this.width,image.height=this.height,image.src=dataUrl,image}},{}],32:[function(require,module,exports){var FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){for(var imageResources=[],imageResourcesEnd=fileHelper.pointer+fileHelper.readUint32();fileHelper.pointer<imageResourcesEnd;){var block={};if("8BIM"===fileHelper.readString(4)){block.id=fileHelper.readUint16(),block.name=fileHelper.readPascalString("evenLength");var dataLength=fileHelper.readUint32();block.data=fileHelper.readUint8Array(dataLength),dataLength%2!==0&&fileHelper.skip(1),imageResources.push(block)}}return imageResources},exports.compose=function(fileHelper,psd){var psd=psd||{};if(void 0===psd.imageResources)fileHelper.extend(4),fileHelper.writeUint32(0);else{var sectionData=new FileHelper;sectionData.create(0);for(var i=0;i<psd.imageResources.length;i++){if(sectionData.extend(4),sectionData.writeString("8BIM"),sectionData.extend(2),sectionData.writeUint16(psd.imageResources[i].id),void 0===psd.imageResources[i].name||0===psd.imageResources[i].name.length)sectionData.extend(2),sectionData.writeString("\x00\x00");else{var nameLength=2*Math.ceil(psd.imageResources[i].name.length/2)+1;sectionData.extend(nameLength),sectionData.writePascalString(psd.imageResources[i].name,"evenLength")}sectionData.extend(4),sectionData.writeUint32(psd.imageResources[i].data.length),sectionData.extend(psd.imageResources[i].data.length),sectionData.writeUint8Array(psd.imageResources[i].data),psd.imageResources[i].data.length%2!==0&&(sectionData.extend(1),sectionData.writeUint8(0))}fileHelper.extend(4),fileHelper.writeUint32(sectionData.arrayBuffer.byteLength),fileHelper.extend(sectionData.arrayBuffer.byteLength),fileHelper.writeUint8Array(new Uint8Array(sectionData.arrayBuffer))}}},{"./FileHelper.js":1}],33:[function(require,module,exports){var layerInfo=require("./layerInfo.js"),channelImageData=require("./channelImageData.js"),globalLayerMaskInfo=require("./globalLayerMaskInfo.js");exports.parse=function(fileHelper){var layerAndMaskInformation={},sectionLength=fileHelper.readUint32(),startPosition=fileHelper.pointer;return layerAndMaskInformation.layers=layerInfo.parse(fileHelper),channelImageData.parse(fileHelper,layerAndMaskInformation.layers),layerAndMaskInformation.globalLayerMaskInfo=globalLayerMaskInfo.parse(fileHelper),fileHelper.skip(sectionLength-(fileHelper.pointer-startPosition)),layerAndMaskInformation},exports.compose=function(fileHelper,psd){var psd=psd||{},layerInfoBuffer=layerInfo.compose(fileHelper,psd),channelImageDataBuffer=channelImageData.compose(fileHelper,psd),globalLayerMaskInfoBuffer=globalLayerMaskInfo.compose(fileHelper,psd),sectionLength=layerInfoBuffer.byteLength+channelImageDataBuffer.byteLength+globalLayerMaskInfoBuffer.byteLength;fileHelper.extend(4),fileHelper.writeUint32(sectionLength),fileHelper.extend(sectionLength),fileHelper.writeUint8Array(new Uint8Array(layerInfoBuffer)),fileHelper.writeUint8Array(new Uint8Array(channelImageDataBuffer)),fileHelper.writeUint8Array(new Uint8Array(globalLayerMaskInfoBuffer))}},{"./channelImageData.js":26,"./globalLayerMaskInfo.js":28,"./layerInfo.js":34}],34:[function(require,module,exports){var layerRecord=require("./layerRecord.js"),FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){var layers=[];fileHelper.skip(4);var layerCount=fileHelper.readInt16();0>layerCount&&(layerCount=Math.abs(layerCount));for(var i=0;layerCount>i;i++)layers.push(layerRecord.parse(fileHelper));return layers},exports.compose=function(fileHelper,psd){var psd=psd||{},sectionData=new FileHelper;if(sectionData.create(4),void 0!==psd.layers&&void 0!==psd.layers[0]){sectionData.skip(4),sectionData.extend(2),sectionData.writeUint16(psd.layers.length);for(var i=0;i<psd.layers.length;i++){var layerData=new Uint8Array(layerRecord.compose(psd.layers[i]));sectionData.extend(layerData.length),sectionData.writeUint8Array(layerData)}var sectionLength=sectionData.arrayBuffer.byteLength;sectionData.revert(sectionLength);for(var i=0;i<psd.layers.length;i++)for(var j=0;j<psd.layers[i].channels.length;j++)sectionLength+=psd.layers[i].channels[j].data.length+2;sectionData.writeUint32(sectionLength)}return sectionData.arrayBuffer}},{"./FileHelper.js":1,"./layerRecord.js":36}],35:[function(require,module,exports){var FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){var maskData={},sectionLength=fileHelper.readUint32();return 0!==sectionLength&&(maskData.top=fileHelper.readUint32(),
maskData.left=fileHelper.readUint32(),maskData.bottom=fileHelper.readUint32(),maskData.right=fileHelper.readUint32(),maskData.width=maskData.right-maskData.left,maskData.height=maskData.bottom-maskData.top,maskData.defaultColor=fileHelper.readUint8(),maskData.flags=fileHelper.read8Bits(),maskData.flags=maskData.flags.slice(0,5),1===maskData.flags[4]&&console.error("FATAL ERROR: Mask Parsing not fully implemented"),20===sectionLength?fileHelper.skip(2):console.error("FATAL ERROR: Mask Parsing not fully implemented")),maskData},exports.compose=function(record){var sectionData=new FileHelper;return void 0===record.maskData||void 0===record.maskData.top?(sectionData.create(4),sectionData.writeUint32(0)):(sectionData.create(24),sectionData.writeUint32(20),sectionData.writeUint32(record.maskData.top),sectionData.writeUint32(record.maskData.left),sectionData.writeUint32(record.maskData.bottom),sectionData.writeUint32(record.maskData.right),sectionData.writeUint8(record.maskData.defaultColor||255),record.maskData.flags=record.maskData.flags||[0,0,0,0,0],record.maskData.flags.push(0,0,0),sectionData.write8Bits(record.maskData.flags),sectionData.writeUint16(0)),sectionData.arrayBuffer}},{"./FileHelper.js":1}],36:[function(require,module,exports){var blendModes=require("./blendModes.js"),layerMaskData=require("./layerMaskData.js"),blendingRanges=require("./blendingRanges.js"),additionalLayerInfo=require("./additionalLayerInfo.js"),imageHelper=require("./imageHelper.js"),FileHelper=require("./FileHelper.js");exports.parse=function(fileHelper){var record={};record.top=fileHelper.readUint32(),record.left=fileHelper.readUint32(),record.bottom=fileHelper.readUint32(),record.right=fileHelper.readUint32(),record.width=record.right-record.left,record.height=record.bottom-record.top;var channelCount=fileHelper.readUint16();record.channelInfo=[];for(var i=0;channelCount>i;i++)record.channelInfo.push({id:fileHelper.readInt16(),dataLength:fileHelper.readUint32()});fileHelper.skip(4),record.blendMode=blendModes[fileHelper.readString(4)],record.opacity=fileHelper.readUint8(),record.clipping=fileHelper.readUint8(),record.flags=fileHelper.read8Bits(),record.flags=record.flags.slice(0,5),fileHelper.skip(1);var extraDataEnd=fileHelper.pointer+fileHelper.readUint32();for(record.maskData=layerMaskData.parse(fileHelper),record.blendingRanges=blendingRanges.parse(fileHelper),record.name=fileHelper.readPascalString("multipleOfFourBytes"),record.additionalLayerInfo=[];fileHelper.pointer<extraDataEnd;){var item=additionalLayerInfo.parse(fileHelper);record.additionalLayerInfo.push(item)}return record.toBase64=imageHelper.toBase64,record.toPng=imageHelper.toPng,record},exports.compose=function(record){var record=record||{},sectionData=new FileHelper;sectionData.create(34+6*record.channels.length),sectionData.writeUint32(record.top),sectionData.writeUint32(record.left),sectionData.writeUint32(record.bottom),sectionData.writeUint32(record.right),sectionData.writeUint16(record.channels.length);for(var i=0;i<record.channels.length;i++)sectionData.writeUint16(record.channels[i].id),sectionData.writeUint32(record.channels[i].data.length+2);sectionData.writeString("8BIM");var blendModeKey=Object.keys(blendModes).filter(function(key){return blendModes[key]===record.blendMode})[0];sectionData.writeString(blendModeKey||"norm"),sectionData.writeUint8(record.opacity||255),sectionData.writeUint8(record.clipping||0),record.flags=record.flags||[0,0,0,0,0],record.flags.push(0,0,0),sectionData.write8Bits(record.flags),sectionData.writeUint8(0);var layerMaskDataSection=layerMaskData.compose(record),blendingRangesSection=blendingRanges.compose(record),additionalLayerInfoSection=additionalLayerInfo.compose(record),nameLength=4*Math.ceil((record.name.length+1)/4),extraDataLength=layerMaskDataSection.byteLength+blendingRangesSection.byteLength;return extraDataLength+=nameLength+additionalLayerInfoSection.byteLength,sectionData.writeUint32(extraDataLength),sectionData.extend(extraDataLength),sectionData.writeUint8Array(new Uint8Array(layerMaskDataSection)),sectionData.writeUint8Array(new Uint8Array(blendingRangesSection)),sectionData.writePascalString(record.name,"multipleOfFourBytes"),sectionData.writeUint8Array(new Uint8Array(additionalLayerInfoSection)),sectionData.arrayBuffer}},{"./FileHelper.js":1,"./additionalLayerInfo.js":2,"./blendModes.js":24,"./blendingRanges.js":25,"./imageHelper.js":31,"./layerMaskData.js":35}],37:[function(require,module,exports){var FileHelper=require("./FileHelper.js"),header=require("./header.js"),colorModeData=require("./colorModeData.js"),imageResources=require("./imageResources.js"),layerAndMaskInfo=require("./layerAndMaskInfo.js"),imageHelper=require("./imageHelper.js"),imageData=require("./imageData.js");exports.parse=function(arrayBuffer){var psd={},fileHelper=new FileHelper;fileHelper.open(arrayBuffer);var headerData=header.parse(fileHelper);if(8!==headerData.depth||"RGB"!==headerData.colormode)console.error("ERROR: Only 8 Bit RGB PSDs are supported!!");else{if(headerData.valid){psd.channels=headerData.channels,psd.height=headerData.height,psd.width=headerData.width,psd.depth=headerData.depth,psd.colormode=headerData.colormode,psd.colorModeData=colorModeData.parse(fileHelper),psd.imageResources=imageResources.parse(fileHelper);var lmi=layerAndMaskInfo.parse(fileHelper);return psd.layers=lmi.layers,psd.globalLayerMaskInfo=lmi.globalLayerMaskInfo,psd.imageData=imageData.parse(fileHelper,psd.width,psd.height,psd.channels),psd.toBase64=imageHelper.toBase64.bind({width:psd.width,height:psd.height,channels:[{id:0,data:psd.imageData[0]},{id:1,data:psd.imageData[1]},{id:2,data:psd.imageData[2]},{id:-1,data:psd.imageData[3]}]}),psd.toPng=imageHelper.toPng.bind({width:psd.width,height:psd.height,toBase64:psd.toBase64}),psd}console.error("ERROR: The provided file is not a valid Photoshop file!")}},exports.compose=function(psd,options){var options=options||{output:"arrayBuffer"},fileHelper=new FileHelper;return fileHelper.create(0),header.compose(fileHelper,psd),colorModeData.compose(fileHelper),imageResources.compose(fileHelper,psd),layerAndMaskInfo.compose(fileHelper,psd),imageData.compose(fileHelper,psd),"blob"===options.output?new Blob([fileHelper.arrayBuffer],{type:"image/vnd.adobe.photoshop"}):fileHelper.arrayBuffer}},{"./FileHelper.js":1,"./colorModeData.js":27,"./header.js":29,"./imageData.js":30,"./imageHelper.js":31,"./imageResources.js":32,"./layerAndMaskInfo.js":33}],38:[function(require,module,exports){exports.decode=function(encodedArray){for(var decodedArray=[],i=0;i<encodedArray.length;){var n=encodedArray[i];if(encodedArray[i]>-1)for(var j=0;n+1>j;j++)i++,decodedArray.push(encodedArray[i]);else if(encodedArray[i]>-128){i++;for(var j=0;1-n>j;j++)decodedArray.push(encodedArray[i])}i++}return Uint8Array.from(decodedArray)}},{}]},{},[37])(37)});
